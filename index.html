<!DOCTYPE html>
<html lang="it">
<head>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0e8a8a" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ARPAV & Aree Protezione Civile ‚Äì Castelfranco Veneto</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://unpkg.com/osmtogeojson@3.0.0-beta.5/osmtogeojson.js"></script>

  <style>


	  .btn-clear-notifs {
		  padding: 6px 10px;
		  font-size: 0.8rem;
		  border-radius: 999px;
		  border: 1px solid rgba(255,255,255,0.7);
		  background: rgba(255,255,255,0.12);
		  color: #ffffff;
		  cursor: pointer;
		}
		
		.btn-clear-notifs:hover {
		  background: rgba(255,255,255,0.22);
		}



	.notification-item {
    background: #ffffff;
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.notif-title {
    font-weight: 700;
    font-size: 0.85rem;
    color: #1e293b;
    margin-bottom: 3px;
}

.notif-body {
    font-size: 0.8rem;
    color: #475569;
    line-height: 1.4;
}

.notif-time {
    font-size: 0.7rem;
    color: #94a3b8;
    margin-top: 6px;
    text-align: right;
}
  
	/* ‚îÄ‚îÄ MENU NOTIFICHE (SIDE PANEL) ‚îÄ‚îÄ */
	.side-panel {
	  position: fixed;
	  top: 0;
	  right: -320px; /* Nascosto a destra */
	  width: 300px;
	  height: 100%;
	  background: var(--bg-panel);
	  z-index: 10000;
	  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
	  transition: right 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
	  display: flex;
	  flex-direction: column;
	}

	.side-panel.open {
	  right: 0; /* Scorre verso l'interno */
	}

	.side-panel-header {
	  padding: 20px;
	  background: var(--primary);
	  color: white;
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	}

	.side-panel-body {
	  padding: 16px;
	  flex: 1;
	  overflow-y: auto;
	}

	/* Pulsante Rettangolare Arrotondato */
	.btn-rect-rounded {
	  width: 100%;
	  padding: 14px;
	  background: var(--primary);
	  color: white;
	  border: none;
	  border-radius: var(--radius-md);
	  font-weight: 700;
	  font-size: 0.9rem;
	  cursor: pointer;
	  margin-bottom: 20px;
	  box-shadow: 0 4px 12px rgba(14, 138, 138, 0.2);
	  transition: transform 0.2s, background 0.2s;
	}

	.btn-rect-rounded:active {
	  transform: scale(0.98);
	}

	.close-side-panel {
	  background: none;
	  border: none;
	  color: white;
	  font-size: 1.2rem;
	  cursor: pointer;
	}

	.notifications-list {
	  display: flex;
	  flex-direction: column;
	  gap: 12px;
	}

	.notification-placeholder {
	  text-align: center;
	  color: var(--text-muted);
	  font-size: 0.85rem;
	  margin-top: 40px;
	  padding: 0 20px;
	}
  
    /* Layout per impilare i pulsanti a destra */
    .custom-layer-control-container { 
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Animazione di rotazione */
    @keyframes spin-refresh {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .refresh-spinning {
      animation: spin-refresh 1s linear infinite;
    }
    /* ‚îÄ‚îÄ BASE & TYPOGRAPHY ‚îÄ‚îÄ */
    :root {
      --primary: #0e8a8a;
      --primary-dark: #096b6b;
      --primary-light: #e0f2f1;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --bg-body: #f1f5f9;
      --bg-panel: #ffffff;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-float: 0 8px 32px rgba(0, 0, 0, 0.12);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Inter', 'Segoe UI', system-ui, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); }

    /* ‚îÄ‚îÄ STRUTTURA PRINCIPALE ‚îÄ‚îÄ */
    #app { display: flex; flex-direction: column; height: 100vh; position: relative; }
    #map { flex: 1; z-index: 1; min-height: 0; width: 100%; order: 2; }

    /* ‚îÄ‚îÄ PANNELLO DATI (TOP) ‚îÄ‚îÄ */
    #panel {
      width: 100%; height: 420px; max-height: 55vh; flex-shrink: 0; background: var(--bg-panel);
      display: flex; flex-direction: column;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      overflow: hidden; z-index: 2; transition: height 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
      order: 1; border-bottom: 1px solid #e2e8f0;
    }
    #panel.hidden-desktop { height: 0; border-bottom: none; }

    #panel-header {
      background: var(--primary); color: #fff;
      padding: 14px 18px; flex-shrink: 0;
      display: flex; align-items: center; gap: 12px;
    }
    #panel-header-text { flex: 1; min-width: 0; }
    #panel-header-text .title { font-size: 1.05rem; font-weight: 700; line-height: 1.2; letter-spacing: -0.02em; }
    #panel-header-text small { display: block; font-weight: 400; font-size: 0.78rem; opacity: 0.9; margin-top: 3px; }

    #refresh-badge {
      background: rgba(255,255,255,.2); backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,.3); border-radius: 20px;
      padding: 4px 10px; font-size: 0.7rem; font-weight: 600; white-space: nowrap;
      display: none; align-items: center; gap: 6px; flex-shrink: 0;
    }
    #refresh-badge.visible { display: flex; }
    #refresh-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #6ee7b7; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

    #btn-close-panel {
      background: rgba(255,255,255,.15); border: none;
      border-radius: 50%; width: 32px; height: 32px;
      color: #fff; font-size: 1.1rem; cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center; transition: background .2s, transform .2s;
    }
    #btn-close-panel:hover { background: rgba(255,255,255,.3); transform: scale(1.05); }

    /* ‚îÄ‚îÄ TABS SENSORI ‚îÄ‚îÄ */
    #sensor-tabs {
      display: flex; flex-shrink: 0; background: #f8fafc;
      border-bottom: 1px solid #e2e8f0; overflow-x: auto; -webkit-overflow-scrolling: touch;
      padding: 0 8px;
    }
    #sensor-tabs::-webkit-scrollbar { display: none; }
    .s-tab {
      flex: 1; min-width: 100px; padding: 12px 8px;
      font-size: 0.8rem; font-weight: 600; text-align: center;
      cursor: pointer; color: var(--text-muted); border: none; border-bottom: 3px solid transparent;
      background: none; white-space: nowrap; transition: color .2s;
    }
    .s-tab:hover { color: var(--primary); }
    .s-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

    #panel-body { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }

    /* ‚îÄ‚îÄ CONTENUTO PANNELLO ‚îÄ‚îÄ */
    .placeholder {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: var(--text-muted); text-align: center; padding: 30px;
    }
    .placeholder svg { margin-bottom: 16px; opacity: 0.3; color: var(--primary); }
    .placeholder p { font-size: 0.9rem; line-height: 1.5; font-weight: 500; }

    .stat-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; margin-bottom: 16px; }
    .stat-card {
      background: #fff; border-radius: var(--radius-md); padding: 10px 6px;
      text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .stat-card .val { font-size: 1.05rem; font-weight: 800; color: var(--primary); }
    .stat-card .lbl { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }

    .soglie-legend {
      display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;
      padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: var(--radius-md);
    }
    .soglia-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--text-main); font-weight: 500; }
    .soglia-line { width: 20px; height: 0; border-top: 2.5px dashed currentColor; flex-shrink: 0; }

    .chart-wrap { position: relative; height: 200px; margin-bottom: 16px; }
    
    /* ‚îÄ‚îÄ TABELLA ‚îÄ‚îÄ */
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; border: 1px solid #e2e8f0; border-radius: var(--radius-md); overflow: hidden; }
    .data-table th { background: #f1f5f9; padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1; }
    .data-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: #f8fafc; }
    .data-table tr.latest td { background: var(--primary-light); font-weight: 600; color: var(--primary-dark); }
    .data-table tr.over-s3 td { background: #fef2f2; color: #b91c1c; font-weight: 700; }
    .data-table tr.over-s2 td { background: #fff7ed; color: #c2410c; font-weight: 600; }
    .data-table tr.over-s1 td { background: #fefce8; color: #a16207; font-weight: 600; }

    /* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
    .loading { display: flex; align-items: center; justify-content: center; padding: 50px; color: var(--primary); font-size: 0.95rem; font-weight: 500; gap: 12px; }
    .spinner { width: 24px; height: 24px; border: 3px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box { background: #fef2f2; border: 1px solid #fecaca; border-radius: var(--radius-md); padding: 14px; font-size: 0.85rem; color: #b91c1c; line-height: 1.5; font-weight: 500; }

    /* ‚îÄ‚îÄ MAPPA E MARKER ‚îÄ‚îÄ */
    .stn-marker {
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,.4);
      cursor: pointer; background: var(--primary); transition: transform 0.2s;
    }
    .stn-marker:hover { transform: scale(1.1); }
    .stn-marker.active { border: 3px solid #fff; background: #0f172a; transform: scale(1.15); z-index: 1000 !important; }

    /* ‚îÄ‚îÄ MENU LAYER CUSTOM (COLLAPSIBLE) ‚îÄ‚îÄ */
    .custom-layer-control-container { 
        position: relative; 
        font-family: 'Inter', system-ui, sans-serif; 
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
    
    .layer-control-toggle {
      width: 44px; height: 44px; border-radius: 50%; background: #fff; border: none;
      box-shadow: var(--shadow-soft); cursor: pointer; display: flex; align-items: center; justify-content: center;
      color: var(--text-main); transition: all 0.2s; outline: none;
    }
    .layer-control-toggle:hover { background: #f8fafc; color: var(--primary); }
    
    .layer-control-menu {
      position: absolute; top: 0; right: 54px; width: 240px;
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      border-radius: var(--radius-lg); padding: 14px;
      box-shadow: var(--shadow-float); border: 1px solid rgba(255,255,255,0.5);
      opacity: 0; visibility: hidden; transform: translateX(10px) scale(0.95);
      transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); transform-origin: top right;
    }
    .layer-control-menu.open { opacity: 1; visibility: visible; transform: translateX(0) scale(1); }
    
    .layer-control-header { font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--text-main); border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
    .layer-control-section-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: .05em; margin: 12px 0 6px; }
    .layer-control-section-title.first { margin-top: 2px; }
    .layer-control-items { display: flex; flex-direction: column; gap: 8px; }
    
    .layer-control-item {
      display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-main); font-weight: 500; cursor: pointer;
      padding: 4px 0;
    }
    /* Stile personalizzato per le checkbox */
    .layer-control-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer; }
    .layer-swatch { width: 22px; height: 4px; border-radius: 2px; display: inline-block; flex-shrink: 0; }
    .layer-swatch.area { height: 16px; border-radius: 4px; border: 2px solid; }
    
    #btn-load-cpa {
      background: var(--text-main); color: white; border: none; padding: 10px; width: 100%;
      border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: background 0.2s;
      font-weight: 600; margin-top: 14px; display: block;
    }
    #btn-load-cpa:hover { background: #0f172a; }

    /* ‚îÄ‚îÄ FABS (Pulsanti Fluttuanti) ‚îÄ‚îÄ */
    .fab-container { position: fixed; bottom: 24px; left: 16px; z-index: 500; display: flex; flex-direction: column; gap: 12px; }
    
    .fab-btn {
      background: #fff; color: var(--primary); width: 44px; height: 44px;
      border-radius: 50%; border: none; box-shadow: var(--shadow-float);
      cursor: pointer; font-size: 1.2rem; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; outline: none;
    }
    .fab-btn:hover { transform: translateY(-2px); background: var(--primary-light); }
    .fab-btn.primary { background: var(--primary); color: #fff; }
    .fab-btn.primary:hover { background: var(--primary-dark); }

    /* ‚îÄ‚îÄ BARRA ALLERTA ‚îÄ‚îÄ */
    #allerta-bar {
      display: none; position: relative; z-index: 100;
      padding: 10px 16px; cursor: pointer;
      flex-shrink: 0; transition: background .3s;
      order: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #allerta-bar.visible { display: flex; align-items: center; gap: 12px; }
    #allerta-bar-inner { display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap; }
    .allerta-bollino-wrap { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: 600; color: #fff; }
    .allerta-bollino { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(255,255,255,.9); flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    #allerta-bar-title { font-size: 0.85rem; font-weight: 700; color: #fff; opacity: .9; margin-left: auto; white-space: nowrap; }
    #allerta-bar-chevron { color: rgba(255,255,255,.9); font-size: 0.9rem; flex-shrink: 0; }

    /* ‚îÄ‚îÄ MODALI (Allerta & Info) ‚îÄ‚îÄ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    
    .modal-box {
      background: #fff; border-radius: var(--radius-lg); padding: 24px;
      max-width: 450px; width: 92%; max-height: 85vh; overflow-y: auto;
      box-shadow: var(--shadow-float); position: relative;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    /* Bottom sheet per mobile nel modale allerta */
    #allerta-box { border-radius: 20px 20px 0 0; animation: slideUp .3s cubic-bezier(0.2, 0.8, 0.2, 1); align-self: flex-end; width: 100%; max-width: 600px; padding-bottom: env(safe-area-inset-bottom, 30px); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    #allerta-box .drag-handle { width: 40px; height: 5px; background: #cbd5e1; border-radius: 3px; margin: -10px auto 20px; }

    .modal-close-btn {
      position: absolute; top: 16px; right: 16px;
      background: #f1f5f9; border: none; border-radius: 50%;
      width: 32px; height: 32px; font-size: 1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: background 0.2s;
    }
    .modal-close-btn:hover { background: #e2e8f0; color: var(--text-main); }

    .modal-box h2 { font-size: 1.1rem; color: var(--text-main); margin-bottom: 8px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
    .modal-box h3 { font-size: 0.9rem; font-weight: 700; color: var(--text-main); margin: 20px 0 6px; display: flex; align-items: center; gap: 8px; }
    .modal-box p { font-size: 0.85rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 10px; }
    .modal-box a { color: var(--primary); font-weight: 600; text-decoration: none; }
    .modal-box a:hover { text-decoration: underline; }
    
    .info-area-badge { display: inline-block; border-radius: 6px; padding: 3px 8px; font-size: 0.75rem; font-weight: 700; color: #fff; margin-right: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .allerta-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: var(--radius-md); margin-bottom: 8px; background: #f8fafc; border: 1px solid #e2e8f0; }
    .allerta-row .bollino-lg { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .allerta-row .label { font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
    .allerta-row .livello { font-size: 0.85rem; font-weight: 800; margin-left: auto; text-transform: uppercase; }
    
    .allerta-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: .05em; margin: 20px 0 8px; }
    .allerta-section-body { font-size: 0.85rem; color: var(--text-main); line-height: 1.6; background: #f8fafc; border-radius: var(--radius-md); padding: 14px; border: 1px solid #e2e8f0; white-space: pre-wrap; }
    .periodo { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px; font-weight: 500; }

    /* Leaflet Overrides per estetica moderna */
    .leaflet-bar { border: none !important; box-shadow: var(--shadow-soft) !important; border-radius: 8px !important; overflow: hidden; }
    .leaflet-bar a { background-color: #fff !important; color: var(--text-main) !important; width: 36px !important; height: 36px !important; line-height: 36px !important; transition: background 0.2s; }
    .leaflet-bar a:hover { background-color: #f8fafc !important; color: var(--primary) !important; }
    .leaflet-control-attribution { border-radius: 4px 0 0 0; background: rgba(255,255,255,0.8) !important; backdrop-filter: blur(4px); color: var(--text-muted) !important; font-size: 10px !important; }

  </style>
</head>
<body>

<div id="app">

  <div id="allerta-bar" onclick="document.getElementById('allerta-modal').classList.add('open')">
    <div id="allerta-bar-inner">
      <div class="allerta-bollino-wrap"><div class="allerta-bollino" id="bar-bollino-idr"></div><span id="bar-label-idr">Idraulico</span></div>
      <div class="allerta-bollino-wrap"><div class="allerta-bollino" id="bar-bollino-idro"></div><span id="bar-label-idro">Idrogeologico</span></div>
      <div class="allerta-bollino-wrap"><div class="allerta-bollino" id="bar-bollino-temp"></div><span id="bar-label-temp">Temporali</span></div>
    </div>
    <!--<span id="allerta-bar-title">Allerta ARPAV</span> -->
    <span id="allerta-bar-chevron">‚ñ≤</span>
  </div>

  <div id="allerta-modal" class="modal-overlay" style="align-items: flex-end;" onclick="if(event.target===this)this.classList.remove('open')">
    <div id="allerta-box" class="modal-box">
      <div class="drag-handle"></div>
      <button class="modal-close-btn" onclick="document.getElementById('allerta-modal').classList.remove('open')">‚úï</button>
      <h2>‚ö†Ô∏è Bollettino Meteo Regionale</h2>
      <div class="periodo" id="allerta-periodo">‚Äî</div>
      <div id="allerta-rows"></div>
      <div class="allerta-section-title">üìã Previsione Meteo</div>
      <div class="allerta-section-body" id="allerta-meteo">‚Äî</div>
      <div class="allerta-section-title">üåç Effetti al Suolo</div>
      <div class="allerta-section-body" id="allerta-suolo">‚Äî</div>
    </div>
  </div>

  <div id="info-modal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('open')">
    <div id="info-box" class="modal-box">
      <button class="modal-close-btn" onclick="document.getElementById('info-modal').classList.remove('open')">‚úï</button>
      <h2>Informazioni sull'app</h2>
      <h3><span class="info-area-badge" style="background:#166534">Attesa</span> Area di attesa</h3>
      <p>Punto di raccolta sicuro per la popolazione in caso di evacuazione. Recati qui <strong>immediatamente</strong> se ricevi un'allerta di evacuazione. Rimani in attesa di istruzioni.</p>
      <h3><span class="info-area-badge" style="background:#991b1b">Ricovero</span> Area di ricovero</h3>
      <p>Struttura attrezzata per ospitare la popolazione evacuata. Raggiungi quest'area solo se indicato dalle autorit√†.</p>
      <h3><span class="info-area-badge" style="background:#a16207">Ammassamento</span> Area di ammassamento</h3>
      <p>Zona riservata ai soccorritori e ai mezzi di emergenza. <strong>Non accessibile alla popolazione.</strong></p>
      <h3>üì° Dati idrometrici ARPAV</h3>
      <p>Livelli e precipitazioni forniti da <strong>ARPAV</strong>, aggiornati ogni 30 min.<br><a href="https://www.arpa.veneto.it/dati-ambientali/dati-in-diretta/meteo-idro-nivo/pannello-meteo-segnalazioni" target="_blank">‚Üí Dati in diretta ARPAV</a></p>
      <h3>üó∫Ô∏è Dati geografici</h3>
      <p>Corsi d'acqua e aree estratti da <a href="https://www.openstreetmap.org" target="_blank">OpenStreetMap</a> tramite Overpass.</p>
    </div>
  </div>

  <div id="map"></div>

  <div class="fab-container">
    <button id="fab-open" class="fab-btn primary" style="display:none;" onclick="openPanel()" title="Apri dati">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 16l4-4 4 4 4-4"/></svg>
    </button>
    
	<button onclick="toggleNotificationsMenu()" class="fab-btn" title="Notifiche">üîî</button>

<div id="notifications-menu" class="side-panel">
  <div class="side-panel-header">
    <h3>Notifiche</h3>
    <div style="display:flex; align-items:center; gap:8px;">
      <button onclick="clearNotifications()" class="btn-clear-notifs">
        Svuota
      </button>
      <button class="close-side-panel" onclick="toggleNotificationsMenu()">√ó</button>
    </div>
  </div>
  <div class="side-panel-body">
    <button id="btn-subscribe-main" onclick="subscribeUser()" class="btn-rect-rounded">
      Attiva Notifiche Push
    </button>
    <div class="notifications-list">
	   <p class="notification-placeholder">Nessuna notifica recente</p>
	</div>
  </div>
</div>


	
    <button onclick="document.getElementById('info-modal').classList.add('open')" class="fab-btn" title="Informazioni">i</button>
  </div>

  <div id="panel" class="hidden-desktop">
    <div id="panel-header">
      <div id="panel-header-text">
        <div class="title" id="panel-title">Dati stazione</div>
        <small id="panel-subtitle">Seleziona una stazione dalla mappa</small>
      </div>
      <div id="refresh-badge">
        <div class="dot"></div>
        <span style="opacity:.9">Agg. tra:</span>
        <span id="countdown-label">--:--</span>
      </div>
      <button id="btn-close-panel" onclick="closePanel()" title="Chiudi pannello">‚úï</button>
    </div>
    <div id="sensor-tabs" style="display:none"></div>
    <div id="panel-body">
      <div class="placeholder">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>
        </svg>
        <p>Tocca un sensore sulla mappa per<br>visualizzare i dati in tempo reale.</p>
      </div>
    </div>
  </div>
</div>


<script>
// ‚îÄ‚îÄ COSTANTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ARPA_SVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="13" height="13"><rect x="3" y="3" width="1.8" height="12.4" rx=".9" fill="white"/><rect x="3" y="14.2" width="10.5" height="1.8" rx=".9" fill="white"/><path d="M4 3.5 Q9.5 0.5 14 5.5" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round"/><line x1="6.5" y1="4.6" x2="6.5" y2="14.2" stroke="white" stroke-width="1.1" stroke-linecap="round"/><line x1="9.2" y1="3.4" x2="9.2" y2="14.2" stroke="white" stroke-width="1.1" stroke-linecap="round"/><line x1="12" y1="5" x2="12" y2="14.2" stroke="white" stroke-width="1.1" stroke-linecap="round"/></svg>';

const STATIONS = [
  { id: 292, osmNodeId: '12984401383', name: 'Muson dei Sassi', subtitle: 'Castelfranco Veneto', lat: 45.66983651, lon: 11.92027581, soglie: { s1: 1.8, s2: 2.5, s3: 2.9 } },
  { id: 653, osmNodeId: '12984421539', name: 'Avenale',         subtitle: 'Castelfranco Veneto', lat: 45.6540,      lon: 11.9850,       soglie: { s1: 1.5, s2: 1.8, s3: 2.1 } }
];
const SOGLIA_CFG = [
  { key: 's1', label: 'Guardia 1', color: '#eab308' },
  { key: 's2', label: 'Guardia 2', color: '#f97316' },
  { key: 's3', label: 'Guardia 3', color: '#ef4444' }
];
const TYPE_COLOR = {
  LIVIDRO: { border: '#0e8a8a', fill: 'rgba(14,138,138,.15)' },
  PRECCUM: { border: '#0284c7', fill: 'rgba(2,132,199,.15)' },
  PORTATA: { border: '#7c3aed', fill: 'rgba(124,58,237,.15)' },
  DEFAULT: { border: '#0e8a8a', fill: 'rgba(14,138,138,.15)' }
};
const TAB_LABELS = { LIVIDRO: 'Livello idro.', PRECCUM: 'Precipitazioni', PORTATA: 'Portata' };

const CV_BBOX = { s: 45.6230, w: 11.8730, n: 45.7020, e: 12.0020 };

const PROXY    = 'https://corsproxy.io/?';
const XML_URL  = 'https://www.arpa.veneto.it/api/risorse/data-meteo/xml/Ultime48ore.xml';
const CSV_BASE = 'https://meteo.arpa.veneto.it/meteo/dati_meteo/xml/';
const OSM_API  = 'https://api.openstreetmap.org/api/0.6/node/';

const VAPID_PUBLIC = 'BHE0353MlqN8My2C-hhYQsC0XXD3QXAuIGnkf-BzCQaeV-I1sLVWlb_rT-C3Q9BJy6wVVSSWtQRsbO_iRRLEQsc';
const API_BASE = 'https://replica-searching-attempt-graduate.trycloudflare.com';

let activeChart = null, currentId = null, currentSensors = [];
let currentStnRef = null, nextRefresh = null;
const markerRefs = {};

// ‚îÄ‚îÄ PANNELLO UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBadge(show) { document.getElementById('refresh-badge').classList.toggle('visible', show); }

function openPanel() {
  const p = document.getElementById('panel');
  p.classList.remove('hidden-desktop');
  document.getElementById('fab-open').style.display = 'none';
  if (currentId !== null) showBadge(true);
  setTimeout(() => map.invalidateSize(), 350);
}

function closePanel() {
  const p = document.getElementById('panel');
  showBadge(false);
  p.classList.add('hidden-desktop');
  if (currentId !== null) document.getElementById('fab-open').style.display = 'flex';
  setTimeout(() => map.invalidateSize(), 350);
  
  if (activeChart) { activeChart.destroy(); activeChart = null; }
  currentId = null; currentStnRef = null;
  STATIONS.forEach(s => markerRefs[s.id]?.setIcon(buildIcon(s, false)));
}

// --- GESTIONE NOTIFICHE ---

// Salva una notifica in localStorage (max 20)
function _notifSave(notif) {
  let list = [];
  try { list = JSON.parse(localStorage.getItem('notifList') || '[]'); } catch(e) {}
  // Evita duplicati (stesso timestamp+title)
  const key = (notif.title || '') + (notif.timestamp || '');
  if (list.some(n => (n.title||'')+(n.timestamp||'') === key)) return;
  list.unshift(notif);
  if (list.length > 20) list.pop();
  localStorage.setItem('notifList', JSON.stringify(list));
}

// Aggiunge una notifica alla UI (e la persiste in localStorage)
function addNotificationToUI(notif, persist = true) {
  if (persist) _notifSave(notif);
  const listEl = document.querySelector('.notifications-list');
  if (!listEl) return;
  const placeholder = listEl.querySelector('.notification-placeholder');
  if (placeholder) placeholder.remove();
  const item = document.createElement('div');
  item.className = 'notification-item';
  item.innerHTML = `
    <div class="notif-title">${notif.title || ''}</div>
    <div class="notif-body">${notif.body || ''}</div>
    <div class="notif-time">${notif.timestamp || ''}</div>
  `;
  listEl.prepend(item);
}

// Carica le notifiche salvate all'avvio
function loadSavedNotifications() {
  // 1. Prova localStorage (fonte primaria per le notifiche ricevute mentre l'app era aperta)
  let saved = [];
  try { saved = JSON.parse(localStorage.getItem('notifList') || '[]'); } catch(e) {}

  if (saved.length > 0) {
    saved.forEach(n => addNotificationToUI(n, false)); // false = non ri-salvare
    return;
  }

  // 2. Fallback: IndexedDB (notifiche salvate dal Service Worker quando l'app era chiusa)
  try {
    const req = indexedDB.open('NotificheDB', 1);
    req.onsuccess = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('notifications')) return;
      const getAllReq = db.transaction('notifications', 'readonly').objectStore('notifications').getAll();
      getAllReq.onsuccess = () => {
        const notifications = getAllReq.result || [];
        [...notifications].reverse().forEach(n => addNotificationToUI(n, true)); // salva in localStorage
      };
    };
  } catch(e) { console.warn('IndexedDB non disponibile:', e); }
}

// Svuota tutte le notifiche
function clearNotifications() {
  // 1. Pulisci localStorage SUBITO
  localStorage.removeItem('notifList');
  // 2. Pulisci DOM SUBITO
  const listEl = document.querySelector('.notifications-list');
  if (listEl) listEl.innerHTML = '<p class="notification-placeholder">Nessuna notifica recente</p>';
  // 3. Pulisci IndexedDB (best effort, non blocca nulla)
  try {
    const req = indexedDB.open('NotificheDB', 1);
    req.onsuccess = (event) => {
      const db = event.target.result;
      if (db.objectStoreNames.contains('notifications'))
        db.transaction('notifications', 'readwrite').objectStore('notifications').clear();
    };
  } catch(e) {}
}

// Ascolta notifiche in arrivo dal Service Worker in tempo reale
const bc = new BroadcastChannel('notifications-channel');
bc.onmessage = (event) => {
  console.log("Notifica ricevuta in tempo reale:", event.data);
  addNotificationToUI(event.data); // aggiunge UI + salva in localStorage
  setTimeout(() => { if (typeof loadAllerta === 'function') loadAllerta(); }, 1000);
};

// Carica notifiche salvate quando la pagina √® pronta
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadSavedNotifications);
} else {
  loadSavedNotifications();
}

// ‚îÄ‚îÄ MAPPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = L.map('map', { center: [45.6640, 11.9580], zoom: 13, zoomControl: false });
L.control.zoom({ position: 'bottomright' }).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap', maxZoom: 19
}).addTo(map);

// ‚îÄ‚îÄ LAYER GROUPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const waterwayLayerGroup = L.layerGroup().addTo(map);
let cpaLayers = {};
let activeFilters = ['waiting', 'camp', 'staging'];

// ‚îÄ‚îÄ WATERWAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WATERWAY_STYLES = {
  river:   { color: '#2563eb', weight: 4, opacity: 0.8 },
  stream:  { color: '#3b82f6', weight: 2.5, opacity: 0.8 },
  canal:   { color: '#0ea5e9', weight: 3, opacity: 0.8 },
  drain:   { color: '#38bdf8', weight: 2, opacity: 0.7 },
  ditch:   { color: '#7dd3fc', weight: 1.5, opacity: 0.7 },
  default: { color: '#0ea5e9', weight: 2, opacity: 0.7 }
};

function waterwayStyle(feature) {
  const type = feature.properties?.tags?.waterway || feature.properties?.waterway || 'default';
  return WATERWAY_STYLES[type] || WATERWAY_STYLES.default;
}

async function loadWaterways() {
  const { s, w, n, e } = CV_BBOX;
  const query = `
    [out:json][timeout:25];
    (
      way["waterway"~"^(river|stream|canal|drain|ditch)$"](${s},${w},${n},${e});
      relation["waterway"~"^(river|stream|canal|drain|ditch)$"](${s},${w},${n},${e});
    );
    out body; >; out skel qt;
  `;
  try {
    const res   = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
    const data  = await res.json();
    const geojson = osmtogeojson(data);
    waterwayLayerGroup.clearLayers();
    L.geoJSON(geojson, {
      filter: f => { const gt = f.geometry?.type; return gt !== 'Point' && gt !== 'MultiPoint'; },
      style: waterwayStyle,
      onEachFeature: (feature, layer) => {
        const tags = feature.properties?.tags || feature.properties || {};
        const name = tags.name || tags.ref || null;
        const type = tags.waterway || '';
        const labelMap = { river: 'Fiume', stream: 'Torrente/Rio', canal: 'Canale', drain: 'Scolo', ditch: 'Fosso' };
        layer.bindTooltip(
          `<div style="font-family:Inter,sans-serif"><b>${name || labelMap[type] || "Corso d'acqua"}</b>` +
          (name ? `<br><span style="color:#64748b;font-size:.8em">${labelMap[type] || type}</span></div>` : '</div>'),
          { sticky: true, className: 'custom-tooltip' }
        );
        waterwayLayerGroup.addLayer(layer);
      }
    });
  } catch (e) { console.error("Errore corsi d'acqua:", e); }
}

// ‚îÄ‚îÄ AREE PROTEZIONE CIVILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CPA_STYLES = {
  waiting: { color: '#166534', fillColor: '#22c55e', label: 'Attesa' },
  camp:    { color: '#991b1b', fillColor: '#ef4444', label: 'Ricovero' },
  staging: { color: '#a16207', fillColor: '#eab308', label: 'Ammassamento' }
};

function getCPAType(feature) {
  const tags = feature.properties?.tags || feature.properties || {};
  if (tags['emergency:waiting_area'] === 'yes')    return 'waiting';
  if (tags['emergency:camp_area']    === 'yes')    return 'camp';
  if (tags['emergency:staging_area'] === 'rescue') return 'staging';
  return 'waiting';
}

function centroid(feature) {
  const coords = feature.geometry?.coordinates;
  const type   = feature.geometry?.type;
  let pts = [];
  if (type === 'Polygon')           pts = coords[0];
  else if (type === 'MultiPolygon') pts = coords[0][0];
  else if (type === 'LineString')   pts = coords;
  if (!pts.length) return '0,0';
  const lat = pts.reduce((s, c) => s + c[1], 0) / pts.length;
  const lon = pts.reduce((s, c) => s + c[0], 0) / pts.length;
  return `${lat.toFixed(6)},${lon.toFixed(6)}`;
}

async function loadCPA() {
  const btn = document.getElementById('btn-load-cpa');
  if (btn) btn.textContent = 'Caricamento...';
  const { s, w, n, e } = CV_BBOX;
  const query = `
    [out:json][timeout:15];
    (
      way["emergency:waiting_area"="yes"](${s},${w},${n},${e});
      relation["emergency:waiting_area"="yes"](${s},${w},${n},${e});
      way["emergency:camp_area"="yes"](${s},${w},${n},${e});
      relation["emergency:camp_area"="yes"](${s},${w},${n},${e});
      way["emergency:staging_area"="rescue"](${s},${w},${n},${e});
      relation["emergency:staging_area"="rescue"](${s},${w},${n},${e});
    );
    out body; >; out skel qt;
  `;
  try {
    const res   = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
    const data  = await res.json();
    const geojson = osmtogeojson(data);

    Object.values(cpaLayers).forEach(l => map.removeLayer(l));
    cpaLayers = {};

    L.geoJSON(geojson, {
      style: feature => {
        const gt = feature.geometry?.type;
        if (gt === 'Point' || gt === 'MultiPoint') return {};
        const style = CPA_STYLES[getCPAType(feature)] || CPA_STYLES.waiting;
        return { color: style.color, fillColor: style.fillColor, weight: 2.5, fillOpacity: 0.35 };
      },
      onEachFeature: (feature, layer) => {
        const gt = feature.geometry?.type;
        if (gt === 'Point' || gt === 'MultiPoint') return;

        const tags  = feature.properties?.tags || feature.properties || {};
        const type  = getCPAType(feature);
        const style = CPA_STYLES[type] || CPA_STYLES.waiting;
        const name  = tags.name || tags.ref || null;

        layer.bindPopup(`<div style="font-family:'Inter',sans-serif;font-size:0.9rem;">
          <strong style="color:${style.color};font-size:1rem;">${style.label}</strong>
          ${name ? `<br><span style="font-size:0.8rem;color:#64748b;margin-top:4px;display:block;">${name}</span>` : ''}
          <div style="margin-top:12px;">
            <a href="https://www.google.com/maps/dir/?api=1&destination=${centroid(feature)}"
               target="_blank"
               style="display:inline-flex;align-items:center;gap:6px;background:var(--primary);color:#fff;padding:8px 14px;
                      border-radius:8px;text-decoration:none;font-size:0.8rem;font-weight:600;transition:background 0.2s;">
               Naviga con Maps
            </a>
          </div>
        </div>`);

        if (!cpaLayers[type]) cpaLayers[type] = L.layerGroup();
        cpaLayers[type].addLayer(layer);
      }
    });

    activeFilters.forEach(f => { if (cpaLayers[f]) cpaLayers[f].addTo(map); });

  } catch (e) {
    console.error('Errore Overpass CPA:', e);
  } finally {
    if (btn) btn.textContent = 'Aggiorna Dati';
  }
}

function toggleCPA(type) {
  const cb = document.getElementById(`filter-${type}`);
  if (cb.checked) {
    if (!activeFilters.includes(type)) activeFilters.push(type);
    if (cpaLayers[type]) cpaLayers[type].addTo(map);
  } else {
    activeFilters = activeFilters.filter(t => t !== type);
    if (cpaLayers[type]) map.removeLayer(cpaLayers[type]);
  }
}

function toggleWaterways(visible) {
  if (visible) map.addLayer(waterwayLayerGroup);
  else map.removeLayer(waterwayLayerGroup);
}

// Funzione per aprire/chiudere il menu
function toggleNotificationsMenu() {
  const menu = document.getElementById('notifications-menu');
  menu.classList.toggle('open');
  
  // Opzionale: cambia il testo del pulsante se l'utente √® gi√† iscritto
  updateSubscribeButton();
}




	
// Aggiorna visivamente il pulsante se l'utente ha gi√† dato il permesso
async function updateSubscribeButton() {
  const btn = document.getElementById('btn-subscribe-main');
  if (!('Notification' in window)) return;

  if (Notification.permission === 'granted') {
    btn.textContent = 'Notifiche Attive';
    btn.style.background = '#166534';
    btn.style.opacity = '0.8';
  } else if (Notification.permission === 'denied') {
    btn.textContent = 'Notifiche Bloccate';
    btn.style.background = '#dc2626';
  } else {
    btn.textContent = 'Attiva Notifiche Push';
    btn.style.background = 'var(--primary)';
  }
}


// ‚îÄ‚îÄ LAYER SWITCHER UNIFICATO (CUSTOM COLLAPSIBLE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const LayerSwitcher = L.Control.extend({
  options: { position: 'topright' },
  onAdd: function() {
    const container = L.DomUtil.create('div', 'custom-layer-control-container');
    
    container.innerHTML = `
      <button class="layer-control-toggle toggle-menu-btn" title="Livelli Mappa">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
      </button>

      <button id="refresh-osm-btn" class="layer-control-toggle" title="Aggiorna Dati Mappa">
		  <svg id="refresh-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
			<path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.85.83 6.74 2.74L21 8"></path>
			<path d="M21 3v5h-5"></path>
		  </svg>
		</button>

      <div class="layer-control-menu">
        <div class="layer-control-header">Livelli Mappa</div>
        <div class="layer-control-section-title first">Idrografia</div>
        <div class="layer-control-items">
          <label class="layer-control-item">
            <input type="checkbox" id="toggle-waterways" checked onchange="toggleWaterways(this.checked)">
            <span class="layer-swatch" style="background:#2563eb"></span>
            Corsi d'acqua
          </label>
        </div>
        <div class="layer-control-section-title">Aree Protezione Civile</div>
        <div class="layer-control-items">
          ${Object.entries(CPA_STYLES).map(([key, style]) => `
            <label class="layer-control-item">
              <input type="checkbox" id="filter-${key}" checked onchange="toggleCPA('${key}')">
              <span class="layer-swatch area" style="background:${style.fillColor}30;border-color:${style.color}"></span>
              ${style.label}
            </label>
          `).join('')}
        </div>
      </div>
    `;

    L.DomEvent.disableClickPropagation(container);
    L.DomEvent.disableScrollPropagation(container);

    const menuBtn = container.querySelector('.toggle-menu-btn');
    const refreshBtn = container.querySelector('#refresh-osm-btn');
    const refreshIcon = container.querySelector('#refresh-icon');
    const menu = container.querySelector('.layer-control-menu');

    // Gestione Apertura Menu
    menuBtn.addEventListener('click', (e) => {
      e.preventDefault();
      menu.classList.toggle('open');
    });

   
	// Gestione Refresh con Animazione e blocco click multipli
	refreshBtn.addEventListener('click', async (e) => {
	  e.preventDefault();
	  
	  // Se sta gi√† caricando (pulsante disabilitato), ignora il click
	  if (refreshBtn.disabled) return;

	  // 1. Avvia rotazione e disabilita il pulsante
	  refreshIcon.classList.add('refresh-spinning');
	  refreshBtn.disabled = true;
	  refreshBtn.style.opacity = '0.5'; // Opzionale: feedback visivo aggiuntivo
	  
	  try {
		// 2. Esegue il caricamento dei dati e attende che ENTRAMBI finiscano
		await Promise.all([loadWaterways(), loadCPA()]);
	  } catch (err) {
		console.error("Errore durante l'aggiornamento dei dati:", err);
	  } finally {
		// 3. Ferma l'animazione e ripristina il pulsante SOLO a dati caricati (o in caso di errore)
		refreshIcon.classList.remove('refresh-spinning');
		refreshBtn.disabled = false;
		refreshBtn.style.opacity = '1';
	  }
});

    map.on('click', () => menu.classList.remove('open'));
    return container;
  }
});
map.addControl(new LayerSwitcher());


// ‚îÄ‚îÄ MARKER STAZIONI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadOSMNode(stn) {
  try {
    let text;
    try {
      const r = await fetch(OSM_API + stn.osmNodeId + '.json', { signal: AbortSignal.timeout(5000) });
      if (r.ok) text = await r.text();
    } catch {}
    if (!text) {
      const r2 = await fetch(PROXY + encodeURIComponent(OSM_API + stn.osmNodeId + '.json'), { signal: AbortSignal.timeout(8000) });
      if (r2.ok) text = await r2.text();
    }
    if (text) {
      const el = JSON.parse(text)?.elements?.[0];
      if (el?.lat && el?.lon) { stn.lat = el.lat; stn.lon = el.lon; }
      if (el?.tags?.name) stn.osmName = el.tags.name;
    }
  } catch (_) {}
}

function buildIcon(stn, active) {
  const size = active ? 32 : 26, anchor = size / 2;
  return L.divIcon({
    html: `<div class="stn-marker${active ? ' active' : ''}" style="width:${size}px;height:${size}px;">${ARPA_SVG}</div>`,
    className: '', iconSize: [size, size], iconAnchor: [anchor, anchor], popupAnchor: [0, -anchor - 6]
  });
}

function setActiveMarker(id) {
  STATIONS.forEach(s => markerRefs[s.id]?.setIcon(buildIcon(s, s.id === id)));
}

async function initMarkers() {
  // Limite comunale Castelfranco
  fetch('https://nominatim.openstreetmap.org/lookup?osm_type=R&osm_ids=45549&format=json&polygon_geojson=1')
    .then(r => r.json()).then(arr => {
      if (arr?.[0]?.geojson)
        L.geoJSON(arr[0].geojson, { style: { color: 'var(--primary)', weight: 2, fillOpacity: .03, fillColor: 'var(--primary)', dashArray: '6 6' } }).addTo(map);
    }).catch(() => {});

  loadWaterways();
  loadCPA();

  await Promise.all(STATIONS.map(loadOSMNode));
  STATIONS.forEach(stn => {
    const m = L.marker([stn.lat, stn.lon], { icon: buildIcon(stn, false) }).addTo(map)
      .bindTooltip(
        `<div style="font-family:'Inter',sans-serif"><b>${stn.name}</b><br><span style="color:var(--text-muted);font-size:0.85em">${stn.subtitle}</span>` +
        (stn.osmName ? `<br><i style="font-size:.8em;color:#94a3b8">${stn.osmName}</i>` : '') +
        `<br><span style="font-size:.75em;color:#cbd5e1;margin-top:4px;display:block;">Stazione #${stn.id}</span></div>`,
        { direction: 'top', offset: [0, -16], className: 'custom-tooltip' }
      );
    m.on('click', () => { loadStation(stn); openPanel(); });
    markerRefs[stn.id] = m;
  });
}

// ‚îÄ‚îÄ ARPAV: FETCH & PARSING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchText(url) {
  try {
    const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
    if (r.ok) return r.text();
  } catch {}
  const r2 = await fetch(PROXY + encodeURIComponent(url), { signal: AbortSignal.timeout(9000) });
  if (!r2.ok) throw new Error('HTTP ' + r2.status);
  return r2.text();
}

async function loadStation(stn, silent = false) {
  currentId = stn.id; currentStnRef = stn;
  setActiveMarker(stn.id);
  document.getElementById('panel-title').textContent = stn.name;
  document.getElementById('panel-subtitle').textContent = `${stn.subtitle} ‚Äî Staz. ${stn.id}`;
  showBadge(true);
  if (!silent) {
    document.getElementById('sensor-tabs').style.display = 'none';
    document.getElementById('panel-body').innerHTML = '<div class="loading"><div class="spinner"></div>Recupero dati ARPAV...</div>';
    if (activeChart) { activeChart.destroy(); activeChart = null; }
  }
  try {
    const xml = await fetchText(XML_URL);
    const sensors = parseXML(xml, stn.id);
    if (sensors?.length > 0) { currentSensors = sensors; renderTabs(stn, sensors); return; }
  } catch (_) {}
  try {
    const csv = await fetchText(`${CSV_BASE}${String(stn.id).padStart(4, '0')}.csv`);
    const rows = parseCSV(csv);
    if (rows?.length > 0) { currentSensors = [{ type: 'LIVIDRO', paramnm: 'Livello idrometrico', unitnm: 'm', rows }]; renderTabs(stn, currentSensors); return; }
  } catch (e) { showError(e.message); return; }
  showError('Nessun dato disponibile per la stazione #' + stn.id);
}

function parseXML(xmlText, stationId) {
  const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
  let staz = null;
  for (const s of doc.querySelectorAll('STAZIONE')) {
    const el = s.querySelector('IDSTAZ') || s.querySelector('CODSTAZ');
    if (el?.textContent?.trim() == stationId) { staz = s; break; }
  }
  if (!staz) return null;
  const sensors = [];
  for (const sensore of staz.querySelectorAll('SENSORE')) {
    const paramnm = sensore.querySelector('PARAMNM')?.textContent?.trim() || '';
    const type    = (sensore.querySelector('TYPE')?.textContent?.trim() || '').toUpperCase();
    const unitnm  = sensore.querySelector('UNITNM')?.textContent?.trim() || '';
    const g1 = parseFloat(sensore.querySelector('GUARDIA1')?.textContent);
    const g2 = parseFloat(sensore.querySelector('GUARDIA2')?.textContent);
    const g3 = parseFloat(sensore.querySelector('GUARDIA3')?.textContent);
    const rows = [];
    for (const dati of sensore.querySelectorAll('DATI')) {
      const ist = dati.getAttribute('ISTANTE') || '';
      const vm  = parseFloat(dati.querySelector('VM')?.textContent?.trim());
      if (ist && !isNaN(vm)) rows.push({ dt: ist, label: fmtIstante(ist), val: vm });
    }
    rows.sort((a, b) => a.dt > b.dt ? -1 : a.dt < b.dt ? 1 : 0);
    if (rows.length > 0) sensors.push({ type, paramnm, unitnm, rows, soglie: !isNaN(g1) ? { s1: g1, s2: g2, s3: g3 } : null });
  }
  return sensors;
}

function fmtIstante(s) {
  if (s.length < 12) return s;
  return `${s.slice(6,8)}/${s.slice(4,6)} ${s.slice(8,10)}:${s.slice(10,12)}`;
}

function parseCSV(text) {
  const lines = text.trim().split('\n').filter(l => l.trim());
  if (lines.length < 2) return null;
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const p = lines[i].split(';');
    if (p.length < 4) continue;
    const dt  = p[2].trim().replace(/^"|"$/g, '');
    const val = parseFloat(p[3]);
    if (!isNaN(val)) rows.push({ dt, label: dt, val });
  }
  rows.sort((a, b) => a.dt > b.dt ? -1 : a.dt < b.dt ? 1 : 0);
  return rows;
}

// ‚îÄ‚îÄ RENDERING TABS & SENSORI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTabs(stn, sensors) {
  const tabsEl = document.getElementById('sensor-tabs');
  tabsEl.style.display = sensors.length > 1 ? 'flex' : 'none';
  tabsEl.innerHTML = sensors.length > 1
    ? sensors.map((s, i) => `<button class="s-tab${i === 0 ? ' active' : ''}" onclick="switchTab(${i})">${TAB_LABELS[s.type] || s.paramnm}</button>`).join('')
    : '';
  switchTab(0);
}

function switchTab(idx) {
  document.querySelectorAll('.s-tab').forEach((t, i) => t.classList.toggle('active', i === idx));
  if (activeChart) { activeChart.destroy(); activeChart = null; }
  renderSensor(currentStnRef, currentSensors[idx]);
}

function renderSensor(stn, sensor) {
  const isLivello = sensor.type === 'LIVIDRO';
  const soglie    = isLivello ? (sensor.soglie || stn.soglie) : null;
  const rows = sensor.rows, vals = rows.map(r => r.val), unit = sensor.unitnm;
  const last = vals[0];
  const minV = Math.min(...vals).toFixed(3);
  const maxV = Math.max(...vals).toFixed(3);
  const avg  = (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(3);

  let legendHtml = '';
  if (isLivello && soglie) {
    legendHtml = '<div class="soglie-legend">' +
      SOGLIA_CFG.map(c =>
        `<div class="soglia-item"><div class="soglia-line" style="color:${c.color}"></div><span><b>${c.label}</b>: ${soglie[c.key].toFixed(2)} ${unit}</span></div>`
      ).join('') + '</div>';
  }

  const chartRows = [...rows].reverse();
  const labels   = chartRows.map(r => r.label);
  const dataVals = chartRows.map(r => r.val);
  const n   = labels.length;
  const clr = TYPE_COLOR[sensor.type] || TYPE_COLOR.DEFAULT;
  const yMin = Math.max(0, Math.min(...dataVals) * 0.95);
  const yMax = isLivello && soglie
    ? Math.max(Math.max(...dataVals), Math.max(soglie.s1, soglie.s2, soglie.s3)) * 1.10
    : (Math.max(...dataVals) * 1.15) || 1;

  const datasets = [{
    label: `${sensor.paramnm} (${unit})`, data: dataVals,
    borderColor: clr.border, backgroundColor: clr.fill,
    borderWidth: 2, pointRadius: n > 100 ? 0 : 3, pointHoverRadius: 5,
    tension: 0.3, fill: true, order: 10
  }];
  if (isLivello && soglie) {
    SOGLIA_CFG.forEach(c => datasets.push({
      label: `${c.label} ‚Äì ${soglie[c.key].toFixed(2)} ${unit}`,
      data: Array(n).fill(soglie[c.key]),
      borderColor: c.color, backgroundColor: 'transparent',
      borderWidth: 2, borderDash: [6, 4],
      pointRadius: 0, pointHoverRadius: 0,
      fill: false, tension: 0, order: 1
    }));
  }

  document.getElementById('panel-body').innerHTML =
    `<div class="stat-row">
      <div class="stat-card"><div class="val">${last?.toFixed(3) ?? '‚Äì'}</div><div class="lbl">Ultimo (${unit})</div></div>
      <div class="stat-card"><div class="val">${minV}</div><div class="lbl">Min (${unit})</div></div>
      <div class="stat-card"><div class="val">${maxV}</div><div class="lbl">Max (${unit})</div></div>
      <div class="stat-card"><div class="val">${avg}</div><div class="lbl">Media (${unit})</div></div>
    </div>
    ${legendHtml}
    <div class="chart-wrap"><canvas id="sensorChart"></canvas></div>
    <table class="data-table">
      <thead><tr><th>Data / Ora</th><th>${sensor.paramnm} (${unit})</th></tr></thead>
      <tbody id="tbl-body"></tbody>
    </table>`;

  const tbody = document.getElementById('tbl-body');
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    if (i === 0) tr.classList.add('latest');
    else if (isLivello && soglie) {
      if      (r.val >= soglie.s3) tr.classList.add('over-s3');
      else if (r.val >= soglie.s2) tr.classList.add('over-s2');
      else if (r.val >= soglie.s1) tr.classList.add('over-s1');
    }
    tr.innerHTML = `<td>${r.label}</td><td><strong>${r.val.toFixed(3)}</strong></td>`;
    tbody.appendChild(tr);
  });

  if (activeChart) activeChart.destroy();
  const ctx = document.getElementById('sensorChart').getContext('2d');
  
  // Custom font for chart
  Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
  Chart.defaults.color = "#64748b";
  
  activeChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: isLivello && !!soglie, position: 'bottom',
          labels: {
            filter: item => item.datasetIndex > 0,
            boxWidth: 20, boxHeight: 0, padding: 8, font: { size: 11, weight: 500 },
            generateLabels: chart => chart.data.datasets
              .map((ds, i) => ({ text: ds.label, strokeStyle: ds.borderColor, fillStyle: 'transparent', lineWidth: 2, lineDash: [5, 3], datasetIndex: i, hidden: false }))
              .filter((_, i) => i > 0)
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 10, cornerRadius: 8,
          titleFont: { size: 13 }, bodyFont: { size: 12 },
          callbacks: { label: item => item.datasetIndex === 0 ? `${sensor.paramnm}: ${item.raw.toFixed(3)} ${unit}` : item.dataset.label }
        },
        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 6, maxRotation: 0, font: { size: 10 } }, grid: { color: '#f1f5f9' }, border: { display: false } },
        y: { min: yMin, max: yMax, title: { display: true, text: `(${unit})`, font: { size: 10 } }, grid: { color: '#f1f5f9' }, border: { display: false } }
      }
    }
  });
}

function showError(msg) {
  document.getElementById('sensor-tabs').style.display = 'none';
  document.getElementById('panel-body').innerHTML = `<div class="error-box">Errore: ${msg}</div>`;
}

// ‚îÄ‚îÄ AUTO-REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getNextHalfHour() { const halfMs = 30*60*1000, margin = 2*60*1000; return Math.ceil((Date.now()+1000)/halfMs)*halfMs+margin; }
function formatCountdown(ms) { if (ms <= 0) return 'agg...'; const s = Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function scheduleRefresh() { nextRefresh = getNextHalfHour(); tickCountdown(); }
function tickCountdown() {
  const rem = nextRefresh - Date.now();
  document.getElementById('countdown-label').textContent = formatCountdown(rem);
  if (rem <= 0) { if (currentStnRef) loadStation(currentStnRef, true); scheduleRefresh(); }
  else { setTimeout(tickCountdown, 1000); }
}

// ‚îÄ‚îÄ NOTIFICHE PUSH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function urlB64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
  return outputArray;
}

async function subscribeUser() {
  // Controlla se il browser supporta le notifiche push
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    console.log('Push non supportato');
    return;
  }

  try {
    // Richiede il permesso all'utente
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      updateSubscribeButton();
      return;
    }

    const registration = await navigator.serviceWorker.ready;
    
    // Crea la sottoscrizione usando le costanti globali VAPID_PUBLIC e urlB64ToUint8Array
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC)
    });

    // Invia la sottoscrizione al tuo server usando la costante API_BASE
    const response = await fetch(API_BASE + '/api/subscribe', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(subscription)
    });

    if (!response.ok) {
      throw new Error('Salvataggio sul server fallito: ' + response.status);
    }

    console.log('Dispositivo registrato con successo!');
    
    // Aggiorna lo stato del pulsante nel menu
    updateSubscribeButton();
    
  } catch (err) {
    console.error('Errore durante l\'attivazione delle notifiche:', err);
    updateSubscribeButton();
  }
}


// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initMarkers();
scheduleRefresh();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/PC_APP/sw.js')
      .then(reg => console.log('Service Worker registrato!'))
      .catch(err => console.error('Errore registrazione SW:', err));
  });
}

// ‚îÄ‚îÄ BARRA ALLERTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ALLERTA_COLORS = { VERDE: '#10b981', GIALLO: '#eab308', ARANCIONE: '#f97316', ROSSO: '#ef4444' };
const ALLERTA_ORDER  = ['VERDE', 'GIALLO', 'ARANCIONE', 'ROSSO'];

function allertaBgColor(idr, idro, temp) {
  const max = [idr, idro, temp].reduce((a, b) => ALLERTA_ORDER.indexOf(b) > ALLERTA_ORDER.indexOf(a) ? b : a, 'VERDE');
  return ALLERTA_COLORS[max] || '#64748b';
}

async function loadAllerta() {
  try {
    const res = await fetch(API_BASE + '/api/allerta');
    if (!res.ok) return;
    const d = await res.json();
    if (!d || !d.idr) return;

    const bar = document.getElementById('allerta-bar');
    bar.classList.add('visible');
    bar.style.background = allertaBgColor(d.idr, d.idro, d.temp);

    ['idr','idro','temp'].forEach(k => {
      const el = document.getElementById('bar-bollino-' + k);
      const lbl = document.getElementById('bar-label-' + k);
      if (el) el.style.background = ALLERTA_COLORS[d[k]] || '#64748b';
      if (lbl) lbl.textContent = ({ idr: 'Idraulico', idro: 'Idrogeologico', temp: 'Temporali' })[k];
    });

    document.getElementById('allerta-periodo').textContent = d.periodo || '‚Äî';
    document.getElementById('allerta-meteo').textContent   = d.meteo   || '‚Äî';
    document.getElementById('allerta-suolo').textContent   = d.suolo   || '‚Äî';

    const rowsEl = document.getElementById('allerta-rows');
    rowsEl.innerHTML = [
      { key: 'idr',  label: 'Rischio Idraulico' },
      { key: 'idro', label: 'Rischio Idrogeologico' },
      { key: 'temp', label: 'Rischio Idrogeologico per Temporali' }
    ].map(r => `
      <div class="allerta-row">
        <div class="bollino-lg" style="background:${ALLERTA_COLORS[d[r.key]] || '#64748b'}"></div>
        <span class="label">${r.label}</span>
      </div>`).join('');

    setTimeout(() => map.invalidateSize(), 300);
  } catch(e) { console.log('Allerta non disponibile:', e.message); }
}

loadAllerta();
setInterval(loadAllerta, 10 * 60 * 1000);

</script>
</body>
</html>
